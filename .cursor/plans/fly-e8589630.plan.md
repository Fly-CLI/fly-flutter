<!-- e8589630-03f6-49a7-ade2-6afa16a81a14 a53d188a-77d4-4e53-9e1a-cf83f7312e5c -->
# Phase 2 — Structured Logging Migration

## Objectives

- Replace ad‑hoc `mason_logger` usage in core execution paths with structured logging.
- Keep user‑facing UX intact (prompts/spinners still via mason where needed).
- Add CLI flags for log control; enrich logs with consistent context.
- Update tests and docs; maintain backward compatibility.

## Scope

- CLI core: `command_runner.dart`, command registry, system checks, path resolver, template manager interactions, error surfaces.
- Critical commands: new project/service commands, template operations, system diagnostics, plugin loading (if present).
- Testing: golden outputs for human/dev, JSON/prod; integration assertions for lifecycle events; adapter coverage.

## Changes

- Introduce global flags in CLI:
- `--log-level`, `--log-format`, `--log-file`, `--no-color`, `--trace`.
- Enrich context:
- Command name, subcommand path, args, working directory, version, environment, feature flags.
- Replace logging calls:
- Prefer `flylog.Logger` for events; keep `mason_logger` only for UX (prompt/confirm/progress) via `LoggerAdapter`.
- Standard fields and keys:
- `ts`, `level`, `msg`, `logger`, `trace_id`, `span_id`, `command`, `args`, `workspace`, `cli_version`, `fields`.
- Backward compatibility:
- Retain same human messages for user‑visible output; structured logs add context rather than changing wording.

## Validation

- Unit tests for flag parsing → `LoggingConfig`.
- Golden tests for formatters by level and error handling.
- Integration tests: run sample commands with different flags/env and assert lifecycle logs and error logs.
- Smoke test for adapter ensures both mason and structured logs co‑exist sans duplication in UX paths.

## Rollout

- Land flags + partial migration in core; migrate high‑traffic commands next; leave long‑tail commands for Phase 3.
- Document flags and examples in `logging/README.md` and CLI help.

## Risks and Mitigations

- Risk: noisy logs in dev → default `info`; allow `--log-level debug` for deep dives.
- Risk: secrets leak → redaction is on; add tests covering token patterns.
- Risk: breaking UX → retain `mason_logger` for prompts/spinners, only mirror to structured logs when safe.

## Deliverables

- Updated CLI with flags, structured logging in core paths, enriched context.
- Tests and goldens passing; docs updated.

### To-dos

- [ ] Add logging domain types and interfaces
- [ ] Implement HumanFormatter and JsonFormatter with tests
- [ ] Add Console and File appenders with rotation
- [ ] Add Http, Sentry, Datadog appenders with backoff
- [ ] Implement LoggingConfig, flags/env parsing, defaults
- [ ] Build LoggerFactory and root logger assembly
- [ ] Integrate logger into FlyCommandRunner lifecycle
- [ ] Emit structured errors, enrich with context and traces
- [ ] Add RedactionPolicy, sampling, throttling
- [ ] Create mason_logger adapter and migrate usages
- [ ] Add golden/unit/integration tests and CI task