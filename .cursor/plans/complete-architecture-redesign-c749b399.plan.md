<!-- c749b399-caba-4d6f-9062-30b2752f57a3 4a3c9bbf-ca14-4856-9708-710111716f86 -->
# Complete Fly CLI Architecture Redesign

## Overview

Complete redesign of the command workflow system addressing all identified issues: path management, brick detection, middleware enforcement, validation decoupling, and workflow clarity. This is a fresh-start approach prioritizing clean architecture over backwards compatibility.

## Core Architectural Problems Identified

1. **Path Resolution Chaos**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `TemplateManager.findTemplatesDirectory()` uses 5+ fallback strategies (lines 45-82)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - BrickRegistry duplicates path logic with `_determineBrickType()` (lines 191-232)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Commands mix absolute/relative paths inconsistently
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - No single source of truth for file/directory resolution

2. **Tight Coupling**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - BrickRegistry directly calls `TemplateManager.findTemplatesDirectory()` (line 72)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - TemplateManager creates BrickRegistry internally (line 35)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Commands construct paths manually (e.g., `path.join(outputDir, projectName)`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Validation logic scattered across validators, commands, and template manager

3. **Middleware Non-Enforcement**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Middleware pipeline returns `null` to continue (line 164 in command_base.dart)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - No guarantee middleware executes (line 95-98 early return)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - DryRunMiddleware inconsistent behavior between manual test and integration tests
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Priority system exists but no enforcement of execution order

4. **Brick Detection Fragility**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Path-based type detection via string matching (lines 200-232 brick_registry.dart)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Hardcoded directory names ('components', 'projects')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Fails when path structure changes or testing scenarios differ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - No explicit brick type declaration in brick.yaml

5. **Unclear Workflow Chain**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Command execution flow: validators  middleware  lifecycle  execute
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Middleware can short-circuit but unclear when/how
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Context passed everywhere but mutable state unclear
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - No workflow documentation or visual representation

## New Architecture Design

### 1. Path Resolution Service (Single Source of Truth)

**New file:** `packages/fly_cli/lib/src/core/filesystem/path_resolver.dart`

```dart
/// Centralized path resolution service - single source of truth
class PathResolver {
  PathResolver({
    required PathResolverConfig config,
  }) : _config = config;

  final PathResolverConfig _config;
  
  /// Resolve templates root directory
  String resolveTemplatesRoot() {
    return _config.templatesRoot ?? _detectTemplatesRoot();
  }
  
  /// Resolve project output path
  String resolveProjectPath(String projectName, {String? outputDir}) {
    final base = outputDir ?? Directory.current.path;
    return normalize(join(base, projectName));
  }
  
  /// Resolve brick path by type and name
  String resolveBrickPath(BrickType type, String name) {
    final templatesRoot = resolveTemplatesRoot();
    return normalize(join(templatesRoot, type.directory, name));
  }
  
  /// Resolve component output path within project
  String resolveComponentPath(
    String projectRoot,
    ComponentType type,
    String name,
    String feature,
  ) {
    return normalize(
      join(projectRoot, 'lib', 'features', feature, type.directory, name)
    );
  }
  
  String _detectTemplatesRoot() {
    // Single, deterministic detection strategy
    // Order: ENV_VAR  Adjacent to executable  Development path
    final envPath = Platform.environment['FLY_TEMPLATES_PATH'];
    if (envPath != null && Directory(envPath).existsSync()) {
      return normalize(envPath);
    }
    
    final executableDir = dirname(Platform.resolvedExecutable);
    final prodPath = normalize(join(executableDir, '..', 'templates'));
    if (Directory(prodPath).existsSync()) {
      return prodPath;
    }
    
    final devPath = normalize(
      join(Directory.current.path, 'packages', 'fly_cli', 'templates')
    );
    if (Directory(devPath).existsSync()) {
      return devPath;
    }
    
    throw PathResolutionException(
      'Templates directory not found. Set FLY_TEMPLATES_PATH environment variable.'
    );
  }
}

class PathResolverConfig {
  const PathResolverConfig({this.templatesRoot});
  final String? templatesRoot;
}
```

### 2. Brick Manifest System (Explicit Configuration)

**Update:** `packages/fly_cli/templates/*/brick.yaml`

Add explicit type declaration:

```yaml
name: fly_screen
description: Generate a Flutter screen component
version: 1.0.0
type: component.screen  # Explicit type declaration
category: ui
output_path_template: "lib/features/{{feature}}/presentation"
```

**New file:** `packages/fly_cli/lib/src/core/templates/brick_manifest.dart`

```dart
/// Brick manifest - parsed from brick.yaml
class BrickManifest {
  const BrickManifest({
    required this.name,
    required this.version,
    required this.type,
    required this.description,
    this.outputPathTemplate,
    this.variables = const {},
  });
  
  final String name;
  final String version;
  final BrickTypeDescriptor type;  // Parsed from 'type' field
  final String description;
  final String? outputPathTemplate;
  final Map<String, dynamic> variables;
  
  factory BrickManifest.fromYaml(Map yaml) {
    return BrickManifest(
      name: yaml['name'] as String,
      version: yaml['version'] as String,
      type: BrickTypeDescriptor.parse(yaml['type'] as String),
      description: yaml['description'] as String,
      outputPathTemplate: yaml['output_path_template'] as String?,
      variables: yaml['vars'] as Map<String, dynamic>? ?? {},
    );
  }
}

class BrickTypeDescriptor {
  const BrickTypeDescriptor(this.category, this.subcategory);
  
  final String category;  // 'project', 'component'
  final String? subcategory;  // 'screen', 'service', etc.
  
  static BrickTypeDescriptor parse(String typeStr) {
    final parts = typeStr.split('.');
    return BrickTypeDescriptor(
      parts[0],
      parts.length > 1 ? parts[1] : null,
    );
  }
  
  BrickType toLegacyType() {
    if (category == 'project') return BrickType.project;
    if (subcategory == 'screen') return BrickType.screen;
    if (subcategory == 'service') return BrickType.service;
    return BrickType.component;
  }
}
```

### 3. Decoupled Brick Registry

**Rewrite:** `packages/fly_cli/lib/src/core/templates/brick_registry.dart`

```dart
/// Decoupled brick registry - no dependencies on TemplateManager
class BrickRegistry {
  BrickRegistry({
    required PathResolver pathResolver,
    required Logger logger,
  }) : _pathResolver = pathResolver,
       _logger = logger;

  final PathResolver _pathResolver;
  final Logger _logger;
  final Map<String, BrickInfo> _cache = {};
  
  /// Discover all bricks using path resolver
  Future<List<BrickInfo>> discoverBricks({bool refresh = false}) async {
    if (!refresh && _cache.isNotEmpty) return _cache.values.toList();
    
    _cache.clear();
    final templatesRoot = _pathResolver.resolveTemplatesRoot();
    final discovered = <BrickInfo>[];
    
    // Convention: scan known directories
    for (final category in ['projects', 'components']) {
      final categoryPath = join(templatesRoot, category);
      if (!Directory(categoryPath).existsSync()) continue;
      
      await for (final entity in Directory(categoryPath).list()) {
        if (entity is! Directory) continue;
        
        // Look for brick.yaml in each subdirectory
        final brickYaml = File(join(entity.path, 'brick.yaml'));
        if (!brickYaml.existsSync()) continue;
        
        final manifest = await _parseBrickManifest(brickYaml);
        if (manifest == null) continue;
        
        final info = BrickInfo(
          name: manifest.name,
          path: entity.path,
          type: manifest.type.toLegacyType(),
          manifest: manifest,
        );
        
        discovered.add(info);
        _cache[info.name] = info;
      }
    }
    
    return discovered;
  }
  
  Future<BrickManifest?> _parseBrickManifest(File yamlFile) async {
    try {
      final content = await yamlFile.readAsString();
      final yaml = loadYaml(content) as Map;
      return BrickManifest.fromYaml(yaml);
    } catch (e) {
      _logger.warn('Failed to parse brick manifest: ${yamlFile.path}');
      return null;
    }
  }
}
```

### 4. Enforced Middleware Pipeline

**Rewrite:** `packages/fly_cli/lib/src/core/command_foundation/application/command_base.dart`

```dart
/// Middleware execution is now mandatory and enforced
Future<int> run() async {
  try {
    // 1. Validate
    final validation = await _runValidators();
    if (!validation.isValid) {
      return _handleValidationFailure(validation);
    }

    // 2. Execute middleware pipeline (MANDATORY)
    final pipeline = MiddlewarePipeline(middleware: middleware, logger: logger);
    final result = await pipeline.execute(
      context: context,
      command: name,
      executeCommand: () => _executeWithLifecycle(),
    );

    return _handleResult(result);
  } catch (e, stackTrace) {
    await onError(context, e, stackTrace);
    return _handleError(e, stackTrace);
  }
}

/// Lifecycle-wrapped execution
Future<CommandResult> _executeWithLifecycle() async {
  await onBeforeExecute(context);
  final result = await execute();
  await onAfterExecute(context, result);
  return result;
}
```

**New file:** `packages/fly_cli/lib/src/core/command_foundation/domain/middleware_pipeline.dart`

```dart
/// Enforced middleware pipeline with guaranteed execution
class MiddlewarePipeline {
  MiddlewarePipeline({
    required List<CommandMiddleware> middleware,
    required Logger logger,
  }) : _middleware = List.unmodifiable(
         middleware..sort((a, b) => a.priority.compareTo(b.priority))
       ),
       _logger = logger;

  final List<CommandMiddleware> _middleware;
  final Logger _logger;
  
  /// Execute pipeline - returns CommandResult (never null)
  Future<CommandResult> execute({
    required CommandContext context,
    required String command,
    required Future<CommandResult> Function() executeCommand,
  }) async {
    if (_middleware.isEmpty) {
      return executeCommand();
    }
    
    // Build execution chain
    var next = executeCommand;
    
    // Wrap each middleware in reverse order
    for (var i = _middleware.length - 1; i >= 0; i--) {
      final middleware = _middleware[i];
      final previousNext = next;
      
      next = () async {
        _logger.detail('Executing middleware: ${middleware.runtimeType}');
        final result = await middleware.handle(context, previousNext);
        
        // Middleware MUST return a result (short-circuit) or call next()
        if (result != null) {
          _logger.detail('Middleware ${middleware.runtimeType} short-circuited');
          return result;
        }
        
        throw MiddlewareException(
          'Middleware ${middleware.runtimeType} returned null without calling next()'
        );
      };
    }
    
    return next();
  }
}
```

### 5. Decoupled Validation System

**New file:** `packages/fly_cli/lib/src/core/validation/validation_service.dart`

```dart
/// Centralized validation service - decoupled from commands
class ValidationService {
  ValidationService({
    required PathResolver pathResolver,
    required Logger logger,
  }) : _pathResolver = pathResolver,
       _logger = logger;

  final PathResolver _pathResolver;
  final Logger _logger;
  
  /// Validate project name
  ValidationResult validateProjectName(String name) {
    if (!RegExp(r'^[a-z][a-z0-9_]*$').hasMatch(name)) {
      return ValidationResult.failure([
        'Project name must start with a lowercase letter',
        'Only lowercase letters, numbers, and underscores allowed',
      ]);
    }
    return ValidationResult.success();
  }
  
  /// Validate Flutter project exists
  Future<ValidationResult> validateFlutterProject(String projectPath) async {
    final resolvedPath = _pathResolver.normalize(projectPath);
    final pubspec = File(join(resolvedPath, 'pubspec.yaml'));
    
    if (!await pubspec.exists()) {
      return ValidationResult.failure([
        'Not a Flutter project: pubspec.yaml not found',
        'Path checked: $resolvedPath',
      ]);
    }
    
    return ValidationResult.success();
  }
  
  /// Validate brick exists
  Future<ValidationResult> validateBrickExists(
    String brickName,
    BrickRegistry registry,
  ) async {
    final brick = await registry.getBrick(brickName);
    if (brick == null) {
      return ValidationResult.failure([
        'Brick "$brickName" not found',
        'Run "fly doctor" to check template installation',
      ]);
    }
    return ValidationResult.success();
  }
}
```

### 6. Clear Workflow Documentation

**New file:** `packages/fly_cli/lib/src/core/command_foundation/WORKFLOW.md`

```markdown
# Command Execution Workflow

## Execution Flow (Guaranteed Order)

1. **Argument Parsing** (by args package)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Raw CLI arguments  ArgResults
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Global flags extracted (--verbose, --output, --plan)

2. **Validation Phase** (command_base.dart:_runValidators)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Project name format
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Flutter project structure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Required arguments present
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - File system permissions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - STOPS on first failure

3. **Middleware Pipeline** (MANDATORY, ENFORCED)
   Priority order (low to high):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - DryRunMiddleware (5) - checks --plan flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - LoggingMiddleware (10) - logs execution
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - MetricsMiddleware (20) - collects timing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - CachingMiddleware (15) - optional caching
   
   Each middleware can:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Short-circuit: return CommandResult (stops pipeline)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Continue: call next() (proceeds to next middleware)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - MUST do one or the other (enforced)

4. **Lifecycle Hooks** (command_base.dart:_executeWithLifecycle)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - onBeforeExecute() - setup
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - execute() - actual command logic
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - onAfterExecute() - cleanup

5. **Result Handling**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - JSON formatting if --output=json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Human-readable if --output=human
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - Exit code: 0 (success) or 1 (failure)

## Path Resolution Flow

All paths go through PathResolver:

1. Templates root: PathResolver.resolveTemplatesRoot()
2. Project output: PathResolver.resolveProjectPath(name, outputDir)
3. Brick location: PathResolver.resolveBrickPath(type, name)
4. Component output: PathResolver.resolveComponentPath(...)

NO manual path.join() in commands.

## Brick Discovery Flow

1. PathResolver.resolveTemplatesRoot()  base path
2. Scan 'projects/' and 'components/' directories
3. Read brick.yaml from each subdirectory
4. Parse BrickManifest (includes explicit type)
5. Cache in BrickRegistry

NO path-based type detection.
```

## Critical Gaps Identified

### 1. Missing Dependency Injection Integration

- Plan lacks integration with existing ServiceContainer
- No clear service registration/lifecycle management
- PathResolver, BrickRegistry, ValidationService need DI registration

### 2. Error Handling Incomplete

- Existing ErrorCode system not integrated
- PathResolutionException needs proper error codes
- Missing error recovery strategies
- No retry logic for transient failures

### 3. Configuration Management Missing

- No strategy for .flyrc or fly.yaml configuration files
- Environment variables not standardized
- Configuration precedence unclear (ENV > Config File > Defaults)

### 4. Observability Gaps

- No logging strategy defined
- Missing telemetry/metrics collection
- Performance tracking not addressed
- Audit trail for file operations missing

### 5. Testing Strategy Incomplete

- Unit test structure undefined
- Integration test patterns not specified
- Mock/stub strategy for PathResolver unclear
- Contract testing for middleware not addressed

### 6. Backward Compatibility Path Unclear

- Migration for existing templates not detailed
- Version detection strategy missing
- Graceful degradation for old bricks undefined

### 7. Security Considerations Missing

- Path traversal validation needed
- Template injection prevention undefined
- Sandbox execution for untrusted templates not addressed

## Implementation Plan (Revised)

### Phase 1: Foundation & Infrastructure (Week 1-2)

#### 1.1 Configuration System

**New file:** `packages/fly_cli/lib/src/core/config/cli_config.dart`

```dart
class CliConfig {
  const CliConfig({
    this.templatesPath,
    this.cachePath,
    this.logLevel,
    this.telemetryEnabled = true,
  });
  
  final String? templatesPath;
  final String? cachePath;
  final LogLevel? logLevel;
  final bool telemetryEnabled;
  
  factory CliConfig.fromFile(String path) { /* ... */ }
  factory CliConfig.fromEnvironment() { /* ... */ }
  
  /// Merge configs with precedence: ENV > File > Defaults
  CliConfig merge(CliConfig other) { /* ... */ }
}
```

#### 1.2 Path Resolver with Security

**New file:** `packages/fly_cli/lib/src/core/filesystem/path_resolver.dart`

```dart
class PathResolver {
  PathResolver({
    required CliConfig config,
    required Logger logger,
  }) : _config = config, _logger = logger;
  
  final CliConfig _config;
  final Logger _logger;
  
  /// Resolve and validate path (prevents traversal attacks)
  String resolveSafely(String basePath, List<String> segments) {
    final resolved = normalize(joinAll([basePath, ...segments]));
    
    // Security: Ensure resolved path is within base path
    if (!isWithin(basePath, resolved)) {
      throw PathTraversalException(
        'Path traversal detected: $resolved not within $basePath',
        errorCode: ErrorCode.securityViolation,
      );
    }
    
    return resolved;
  }
  
  /// Resolve templates root with fallback strategy
  Result<String> resolveTemplatesRoot() {
    try {
      // 1. Explicit config
      if (_config.templatesPath != null) {
        return Result.success(_validatePath(_config.templatesPath!));
      }
      
      // 2. Environment variable
      final envPath = Platform.environment['FLY_TEMPLATES_PATH'];
      if (envPath != null) {
        return Result.success(_validatePath(envPath));
      }
      
      // 3. Production path (adjacent to executable)
      final prodPath = _resolveProductionPath();
      if (prodPath != null) {
        return Result.success(prodPath);
      }
      
      // 4. Development path
      final devPath = _resolveDevelopmentPath();
      if (devPath != null) {
        return Result.success(devPath);
      }
      
      return Result.failure(
        PathResolutionError(
          'Templates directory not found',
          errorCode: ErrorCode.templateNotFound,
          suggestion: 'Set FLY_TEMPLATES_PATH environment variable or create ~/.flyrc',
        ),
      );
    } catch (e) {
      _logger.err('Path resolution failed: $e');
      return Result.failure(e);
    }
  }
}

/// Path resolution errors with proper error codes
class PathResolutionError extends CliException {
  PathResolutionError(
    String message, {
    required ErrorCode errorCode,
    String? suggestion,
  }) : super(message, errorCode: errorCode, suggestion: suggestion);
}
```

#### 1.3 Result Type for Error Handling

**New file:** `packages/fly_cli/lib/src/core/utils/result.dart`

```dart
/// Result type for operations that can fail
sealed class Result<T> {
  const Result();
  
  factory Result.success(T value) = Success<T>;
  factory Result.failure(Object error) = Failure<T>;
  
  bool get isSuccess => this is Success<T>;
  bool get isFailure => this is Failure<T>;
  
  T? get valueOrNull => switch (this) {
    Success(value: final v) => v,
    Failure() => null,
  };
  
  Object? get errorOrNull => switch (this) {
    Success() => null,
    Failure(error: final e) => e,
  };
  
  /// Map success value
  Result<R> map<R>(R Function(T) transform) {
    return switch (this) {
      Success(value: final v) => Result.success(transform(v)),
      Failure(error: final e) => Result.failure(e),
    };
  }
  
  /// Flat map for chaining operations
  Result<R> flatMap<R>(Result<R> Function(T) transform) {
    return switch (this) {
      Success(value: final v) => transform(v),
      Failure(error: final e) => Result.failure(e),
    };
  }
}

class Success<T> extends Result<T> {
  const Success(this.value);
  final T value;
}

class Failure<T> extends Result<T> {
  const Failure(this.error);
  final Object error;
}
```

#### 1.4 Dependency Injection Setup

**Update:** `packages/fly_cli/lib/src/core/dependency_injection/service_registry.dart`

```dart
/// Central service registry extending ServiceContainer
class ServiceRegistry extends ServiceContainer {
  static ServiceRegistry? _instance;
  static ServiceRegistry get instance => _instance ??= ServiceRegistry._();
  
  ServiceRegistry._();
  
  /// Initialize all core services
  Future<void> initialize({required CliConfig config}) async {
    // Configuration
    registerSingleton<CliConfig>(config);
    
    // Logging
    final logger = Logger();
    registerSingleton<Logger>(logger);
    
    // Path resolution
    registerFactory<PathResolver>(
      () => PathResolver(config: config, logger: logger)
    );
    
    // Brick registry
    registerFactory<BrickRegistry>(
      () => BrickRegistry(
        pathResolver: get<PathResolver>(),
        logger: logger,
      )
    );
    
    // Validation service
    registerFactory<ValidationService>(
      () => ValidationService(
        pathResolver: get<PathResolver>(),
        logger: logger,
      )
    );
    
    // Template manager
    registerFactory<TemplateManager>(
      () => TemplateManager(
        pathResolver: get<PathResolver>(),
        brickRegistry: get<BrickRegistry>(),
        logger: logger,
      )
    );
  }
}
```

### Phase 2: Brick System Redesign (Week 2-3)

#### 2.1 Brick Manifest with Versioning

**New file:** `packages/fly_cli/lib/src/core/templates/brick_manifest_v2.dart`

```dart
/// V2 Brick manifest with explicit configuration
class BrickManifestV2 {
  const BrickManifestV2({
    required this.name,
    required this.version,
    required this.type,
    required this.schemaVersion,
    this.description,
    this.outputPathTemplate,
    this.variables = const {},
    this.dependencies = const [],
  });
  
  final String name;
  final String version;
  final BrickTypeDescriptor type;
  final String schemaVersion;  // "2.0"
  final String? description;
  final String? outputPathTemplate;
  final Map<String, VariableDefinition> variables;
  final List<BrickDependency> dependencies;
  
  /// Detect manifest version from yaml
  static String detectVersion(Map yaml) {
    return yaml['schema_version'] as String? ?? 
           yaml['manifest_version'] as String? ?? 
           '1.0';  // Legacy
  }
  
  factory BrickManifestV2.fromYaml(Map yaml) {
    final version = detectVersion(yaml);
    if (version == '1.0') {
      return _migrateFromV1(yaml);
    }
    return _parseV2(yaml);
  }
  
  /// Migrate V1 to V2 automatically
  static BrickManifestV2 _migrateFromV1(Map yaml) {
    // Infer type from directory structure (backward compat)
    final inferredType = _inferTypeFromName(yaml['name'] as String);
    
    return BrickManifestV2(
      name: yaml['name'] as String,
      version: yaml['version'] as String? ?? '1.0.0',
      type: BrickTypeDescriptor.parse(inferredType),
      schemaVersion: '2.0',
      description: yaml['description'] as String?,
      variables: _parseVariables(yaml['vars']),
    );
  }
}
```

#### 2.2 Decoupled Brick Registry

**Rewrite:** `packages/fly_cli/lib/src/core/templates/brick_registry_v2.dart`

```dart
class BrickRegistryV2 {
  BrickRegistryV2({
    required PathResolver pathResolver,
    required Logger logger,
    CacheStrategy? cacheStrategy,
  }) : _pathResolver = pathResolver,
       _logger = logger,
       _cache = cacheStrategy ?? InMemoryCacheStrategy();

  final PathResolver _pathResolver;
  final Logger _logger;
  final CacheStrategy _cache;
  
  /// Discover bricks with caching
  Future<Result<List<BrickInfo>>> discoverBricks({
    bool forceRefresh = false,
  }) async {
    if (!forceRefresh) {
      final cached = await _cache.get<List<BrickInfo>>('bricks');
      if (cached != null) {
        _logger.detail('Using cached brick list (${cached.length} bricks)');
        return Result.success(cached);
      }
    }
    
    final templatesResult = _pathResolver.resolveTemplatesRoot();
    if (templatesResult.isFailure) {
      return Result.failure(templatesResult.errorOrNull!);
    }
    
    final templatesRoot = templatesResult.valueOrNull!;
    final discovered = <BrickInfo>[];
    
    // Convention-based discovery
    for (final category in BrickCategory.values) {
      final categoryPath = join(templatesRoot, category.directory);
      if (!Directory(categoryPath).existsSync()) {
        _logger.detail('Category not found: ${category.directory}');
        continue;
      }
      
      await for (final entity in Directory(categoryPath).list()) {
        if (entity is! Directory) continue;
        
        final manifestResult = await _loadManifest(entity.path);
        if (manifestResult.isSuccess) {
          final manifest = manifestResult.valueOrNull!;
          discovered.add(BrickInfo(
            name: manifest.name,
            path: entity.path,
            manifest: manifest,
            category: category,
          ));
        }
      }
    }
    
    // Cache results
    await _cache.set('bricks', discovered, ttl: Duration(minutes: 5));
    
    _logger.info('Discovered ${discovered.length} bricks');
    return Result.success(discovered);
  }
}
```

### Phase 3: Middleware & Pipeline (Week 3-4)

#### 3.1 Enforced Middleware Pipeline

**New file:** `packages/fly_cli/lib/src/core/command_foundation/domain/middleware_pipeline_v2.dart`

```dart
/// Enforced middleware pipeline following Chain of Responsibility pattern
class MiddlewarePipeline {
  MiddlewarePipeline({
    required List<CommandMiddleware> middleware,
    required Logger logger,
    TelemetryService? telemetry,
  }) : _middleware = List.unmodifiable(
         middleware..sort((a, b) => a.priority.compareTo(b.priority))
       ),
       _logger = logger,
       _telemetry = telemetry;

  final List<CommandMiddleware> _middleware;
  final Logger _logger;
  final TelemetryService? _telemetry;
  
  /// Execute pipeline with guaranteed execution and observability
  Future<CommandResult> execute({
    required CommandContext context,
    required String command,
    required Future<CommandResult> Function() executeCommand,
  }) async {
    final stopwatch = Stopwatch()..start();
    
    try {
      // Build middleware chain
      final chain = _buildChain(context, executeCommand);
      
      // Execute with timeout
      final result = await chain().timeout(
        Duration(minutes: 5),
        onTimeout: () => CommandResult.error(
          message: 'Command execution timeout',
          errorCode: ErrorCode.timeoutError,
        ),
      );
      
      stopwatch.stop();
      
      // Collect metrics
      _telemetry?.recordCommandExecution(
        command: command,
        durationMs: stopwatch.elapsedMilliseconds,
        success: result.success,
      );
      
      return result;
      
    } catch (e, stackTrace) {
      stopwatch.stop();
      _logger.err('Pipeline execution failed: $e');
      _logger.detail(stackTrace.toString());
      
      _telemetry?.recordCommandError(
        command: command,
        error: e.toString(),
        durationMs: stopwatch.elapsedMilliseconds,
      );
      
      return CommandResult.error(
        message: 'Pipeline execution failed: $e',
        errorCode: ErrorCode.internalError,
        context: ErrorContext.forCommand(command),
      );
    }
  }
  
  /// Build execution chain (reversed middleware order)
  Future<CommandResult> Function() _buildChain(
    CommandContext context,
    Future<CommandResult> Function() executeCommand,
  ) {
    var next = executeCommand;
    
    for (var i = _middleware.length - 1; i >= 0; i--) {
      final middleware = _middleware[i];
      final previousNext = next;
      
      next = () async {
        _logger.detail('[${middleware.runtimeType}] Starting');
        final startTime = DateTime.now();
        
        try {
          // Call middleware handle
          final result = await middleware.handle(context, previousNext);
          
          final duration = DateTime.now().difference(startTime);
          
          if (result != null) {
            // Short-circuit
            _logger.detail(
              '[${middleware.runtimeType}] Short-circuited after ${duration.inMilliseconds}ms'
            );
            return result;
          }
          
          // CRITICAL: If middleware returns null, it MUST have called next()
          // If we reach here, middleware violated the contract
          throw MiddlewareContractViolationException(
            'Middleware ${middleware.runtimeType} returned null without calling next()',
          );
          
        } catch (e) {
          _logger.err('[${middleware.runtimeType}] Error: $e');
          rethrow;
        }
      };
    }
    
    return next;
  }
}

/// Middleware contract violation exception
class MiddlewareContractViolationException extends CliException {
  MiddlewareContractViolationException(String message)
      : super(
          message,
          errorCode: ErrorCode.internalError,
          suggestion: 'This is a bug. Please report it.',
        );
}
```

### Phase 4: Observability & Telemetry (Week 4)

#### 4.1 Telemetry Service

**New file:** `packages/fly_cli/lib/src/core/telemetry/telemetry_service.dart`

```dart
/// Telemetry service for usage analytics and performance monitoring
class TelemetryService {
  TelemetryService({
    required CliConfig config,
    required Logger logger,
  }) : _config = config,
       _logger = logger,
       _enabled = config.telemetryEnabled;

  final CliConfig _config;
  final Logger _logger;
  final bool _enabled;
  final List<TelemetryEvent> _buffer = [];
  
  /// Record command execution
  void recordCommandExecution({
    required String command,
    required int durationMs,
    required bool success,
    Map<String, dynamic>? metadata,
  }) {
    if (!_enabled) return;
    
    _buffer.add(TelemetryEvent(
      type: 'command_execution',
      timestamp: DateTime.now(),
      data: {
        'command': command,
        'duration_ms': durationMs,
        'success': success,
        ...?metadata,
      },
    ));
    
    _flushIfNeeded();
  }
  
  /// Record command error
  void recordCommandError({
    required String command,
    required String error,
    required int durationMs,
  }) {
    if (!_enabled) return;
    
    _buffer.add(TelemetryEvent(
      type: 'command_error',
      timestamp: DateTime.now(),
      data: {
        'command': command,
        'error': error,
        'duration_ms': durationMs,
      },
    ));
    
    _flushIfNeeded();
  }
  
  /// Flush events (every 10 events or on dispose)
  Future<void> _flushIfNeeded() async {
    if (_buffer.length >= 10) {
      await flush();
    }
  }
  
  /// Flush all events
  Future<void> flush() async {
    if (_buffer.isEmpty) return;
    
    try {
      // Write to local analytics file
      await _writeToFile();
      _buffer.clear();
    } catch (e) {
      _logger.detail('Telemetry flush failed: $e');
    }
  }
}
```

### Phase 5: Testing Infrastructure (Week 5)

#### 5.1 Test Utilities

**New file:** `packages/fly_cli/test/utils/test_service_registry.dart`

```dart
/// Test service registry with mocks
class TestServiceRegistry extends ServiceRegistry {
  static TestServiceRegistry create({
    PathResolver? pathResolver,
    BrickRegistry? brickRegistry,
    ValidationService? validationService,
  }) {
    final registry = TestServiceRegistry._();
    
    // Register test config
    final config = CliConfig(
      templatesPath: 'test/fixtures/templates',
      cachePath: null,
      logLevel: LogLevel.error,
      telemetryEnabled: false,
    );
    registry.registerSingleton<CliConfig>(config);
    
    // Register mocks or real services
    final logger = Logger(level: Level.error);
    registry.registerSingleton<Logger>(logger);
    
    registry.registerSingleton<PathResolver>(
      pathResolver ?? MockPathResolver()
    );
    
    registry.registerSingleton<BrickRegistry>(
      brickRegistry ?? MockBrickRegistry()
    );
    
    registry.registerSingleton<ValidationService>(
      validationService ?? MockValidationService()
    );
    
    return registry;
  }
  
  TestServiceRegistry._() : super._();
}
```

#### 5.2 Contract Tests for Middleware

**New file:** `packages/fly_cli/test/core/middleware_contract_test.dart`

```dart
/// Contract tests ensuring all middleware follow the protocol
void main() {
  group('Middleware Contract Tests', () {
    test('DryRunMiddleware must call next() when not in plan mode', () async {
      // Arrange
      final context = createTestContext(planMode: false);
      var nextCalled = false;
      Future<CommandResult> next() async {
        nextCalled = true;
        return CommandResult.success(command: 'test', message: 'ok');
      }
      
      final middleware = DryRunMiddleware();
      
      // Act
      await middleware.handle(context, next);
      
      // Assert
      expect(nextCalled, isTrue, reason: 'next() must be called');
    });
    
    test('DryRunMiddleware must NOT call next() in plan mode', () async {
      // Arrange
      final context = createTestContext(planMode: true);
      var nextCalled = false;
      Future<CommandResult> next() async {
        nextCalled = true;
        return CommandResult.success(command: 'test', message: 'ok');
      }
      
      final middleware = DryRunMiddleware();
      
      // Act
      final result = await middleware.handle(context, next);
      
      // Assert
      expect(result, isNotNull, reason: 'Must return result');
      expect(nextCalled, isFalse, reason: 'next() must NOT be called');
    });
  });
}
```

### Phase 6: Migration & Documentation (Week 6)

#### 6.1 Migration Command

**New file:** `packages/fly_cli/lib/src/features/migrate/application/migrate_command.dart`

```dart
/// Command to migrate old templates to new format
class MigrateCommand extends FlyCommand {
  @override
  Future<CommandResult> execute() async {
    final templatesPath = argResults!['templates'] as String?;
    
    logger.info('Migrating templates to V2 format...');
    
    // Scan for brick.yaml files
    final bricks = await _findBrickManifests(templatesPath);
    
    for (final brickPath in bricks) {
      await _migrateBrick(brickPath);
    }
    
    return CommandResult.success(
      command: 'migrate',
      message: 'Migrated ${bricks.length} templates to V2 format',
    );
  }
  
  Future<void> _migrateBrick(String path) async {
    final yamlFile = File(join(path, 'brick.yaml'));
    final yaml = loadYaml(await yamlFile.readAsString()) as Map;
    
    // Add schema_version if missing
    if (!yaml.containsKey('schema_version')) {
      yaml['schema_version'] = '2.0';
    }
    
    // Add explicit type if missing
    if (!yaml.containsKey('type')) {
      yaml['type'] = _inferType(path);
    }
    
    // Write back
    await yamlFile.writeAsString(yamlEncoder.convert(yaml));
    logger.info(' Migrated: $path');
  }
}
```

## Key Improvements Over Original Plan

1. **Error Handling**: Integrated Result type, proper ErrorCode usage, retry logic
2. **Configuration**: Added CliConfig with ENV/File precedence
3. **Security**: Path traversal prevention, validation at resolution time
4. **Observability**: Telemetry service, structured logging, performance tracking
5. **Testing**: Contract tests, mock registry, test utilities
6. **DI Integration**: Proper ServiceRegistry with lifecycle management
7. **Backward Compatibility**: Automatic V1 to V2 migration, version detection
8. **Industry Standards**: Result type, Chain of Responsibility, Repository pattern

## Key Benefits

1. **Single Source of Truth**: PathResolver handles ALL path resolution
2. **Explicit Configuration**: Brick types declared in manifest, not inferred
3. **Decoupled Components**: Each service has single responsibility
4. **Enforced Middleware**: Pipeline execution guaranteed, no silent bypassing
5. **Clear Workflow**: Documented, visual, predictable execution order
6. **Testable**: Each component can be tested in isolation
7. **Maintainable**: Changes localized to specific services

## Breaking Changes

- Old templates without `type` field in brick.yaml won't work
- Custom brick paths must use new PathResolverConfig
- Direct TemplateManager instantiation deprecated
- Command subclasses must use new middleware signature

## Migration Path

Provide `fly migrate` command to:

1. Scan existing brick.yaml files
2. Add `type` field based on directory structure
3. Add `output_path_template` if missing
4. Generate migration report